---
layout: post
title: jquery使用
categories:
    - ror
tags:
    - rails
excerpt: 本文为显示一个产品并允许顾客添加评论。当一条评论添加后，被显示在评论列表，i评论数目增加，表单重置并显示一条感谢评论的flash消息。   
---

## 添加非侵入式的javascript

表单id为*new_review*，下面代码通过一个ajax当时提交这个表单。
{% highlight javascript %}
$(document).ready(function(){
	$("#new_review").submit(function(){
		$.post($(this).attr('action'),$(this).serialize(),null,"script");
		return false;
	});
});    
{% endhighlight %}
**$.post()方法参数说明：**
1. 提交url；
2. 要传输的数据，使用jquery的serialize方法，它将要发送到服务器的表单元素序列化成一系列的键值对；
3. 回到函数；
4. script代表服务器返回浏览器可执行的javascript代码。

## 更新Controller
控制器需要完成的工作是：保存新评论并重定向到产品页面。
{% highlight javascript %}
def create
	@review = Review.create!(params[:review])
	flash[:notice] = "babababa"
	response_to
		formate.html { redirect_to @review.product }
		formate.js
	end	
end   
{% endhighlight %}

要返回的js代码放到*/app/view/reviews/create.js.erb*。文件内容如下：
{% highlight javascript %}
alert('Hello from AJAX'); 
{% endhighlight %}

添加报头告诉Rails调用js块，返回js.erb文件的内容：
{% highlight javascript %}
jQuery.ajaxSetup({
	'beforeSend' : function(xhr){ xhr.setRequestHeader("Accept" , "text/javascript")}
}); 
{% endhighlight %}

## 更新页面

1. 首先，我们将在页面添加flash消息感谢用户添加评论，我们用在表单前添加一个div的方式实现。
{% highlight javascript %}
$("#new_review").before('<div id="flash_notice"><%= escape_javascript(flash.delete(:notice)) %></div>'); 
{% endhighlight %}

为了添加动态内容， 我们在JavaScript中嵌入erb标签。我们使用escape_javascript保证从erb中输出安全的JavaScript。请注意，我们马上调用flash.delete方法清除flash消息保证它不会出现在下次请求中。

2. 用来显示评论数量的页面元素也应该被更新，它的id叫做reviews_count。jQuery的html方法可以用来更新它的内容。
{% highlight javascript %}
$('#reviews_count').html('<%= pluralize(@review.product.reviews.count, "Review") %>');
{% endhighlight %}

3. 接下来我们将在评论列表里添加一条新评论。评论是根据id有序显示的。每一条评论都被当作一个列表项通过一个paritial渲染。我们可以通过partial渲染一条新评论并且把它添加到评论列表里。
{% highlight javascript %}
$('#reviews').append("<%= escape_javascript(render(:partial => @review)) %>"); 
{% endhighlight %}

4. 最后重置表单
{% highlight javascript %}
$('#new_review')[0].reset();
{% endhighlight %}

## jquery扩展

如果希望网站上的多个表单都能够这样做，那么我们可以把这段代码抽取到一个新jQuery函数里，因此我们可以调用
{% highlight javascript %}
$('#new_review').submitWithAjax();  
{% endhighlight %}

在jquery我们可以如下扩展函数：
{% highlight javascript %}
jQuery.fn.submitWithAjax = function(){
	this.submit(function(){
    	$.post($(this).attr('action'), $(this).serialize(), null, "script");    
    	return false;   		
	});
}  
{% endhighlight %}

